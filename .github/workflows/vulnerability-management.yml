name: Vulnerability Management (Docker Scout)

on:
  # Se ejecuta manualmente desde la pestaña "Actions"
  workflow_dispatch:
    inputs:
      base_tag:
        description: "Tag de la imagen base (versión anterior)"
        required: true
      target_tag:
        description: "Tag de la imagen objetivo (versión nueva)"
        required: true

env:
  REGISTRY: docker.io
  IMAGE_NAME: arlethl/scout-cli

jobs:
  manage:
    runs-on: ubuntu-latest

    env:
      BASE_TAG: ${{ github.event.inputs.base_tag }}
      TARGET_TAG: ${{ github.event.inputs.target_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Pull base and target images
        run: |
          docker pull $REGISTRY/$IMAGE_NAME:$BASE_TAG
          docker pull $REGISTRY/$IMAGE_NAME:$TARGET_TAG

      - name: Install Docker Scout CLI
        run: |
          curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s --
          echo "$HOME/.docker/bin" >> $GITHUB_PATH

      # 1) Identificación: CVEs de la versión anterior
      - name: CVE scan (base image)
        run: |
          docker scout cves $REGISTRY/$IMAGE_NAME:$BASE_TAG \
            --only-severities critical,high,medium \
            --output json > cves-base.json || echo "{}" > cves-base.json

      # 2) Identificación: CVEs de la versión nueva
      - name: CVE scan (target image)
        run: |
          docker scout cves $REGISTRY/$IMAGE_NAME:$TARGET_TAG \
            --only-severities critical,high,medium \
            --output json > cves-target.json || echo "{}" > cves-target.json

      # 3) Comparación de versiones
      - name: Compare base vs target image
        run: |
          docker scout compare \
            $REGISTRY/$IMAGE_NAME:$BASE_TAG \
            $REGISTRY/$IMAGE_NAME:$TARGET_TAG \
            --only-severities critical,high,medium \
            --output json > scout-compare.json || echo "{}" > scout-compare.json

      # 4) Recomendaciones de remediación sobre la nueva imagen
      - name: Recommendations (target image)
        run: |
          docker scout recommendations $REGISTRY/$IMAGE_NAME:$TARGET_TAG \
            --only-severities critical,high,medium \
            --output json > scout-recommendations.json || echo "{}" > scout-recommendations.json

      # 5) Publicar todos los reportes como artefactos
      - name: Upload vulnerability management artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-management-reports
          path: |
            cves-base.json
            cves-target.json
            scout-compare.json
            scout-recommendations.json

