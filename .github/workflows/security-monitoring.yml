name: Security Monitoring (Docker Scout)

on:
  # Corre todos los dÃ­as a las 3 AM (UTC)
  schedule:
    - cron: "0 3 * * *"
  # Permite dispararlo manualmente desde Actions
  workflow_dispatch:

env:
  REGISTRY: docker.io
  IMAGE_NAME: arlethl/scout-cli
  IMAGE_TAG: latest

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PAT }}

      - name: Pull monitored image
        run: |
          docker pull $REGISTRY/$IMAGE_NAME:$IMAGE_TAG

      - name: Install Docker Scout CLI
        run: |
          curl -sSfL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh | sh -s --
          echo "$HOME/.docker/bin" >> $GITHUB_PATH

      - name: Generate security metrics (JSON)
        run: |
          docker scout cves $REGISTRY/$IMAGE_NAME:$IMAGE_TAG \
            --only-severities critical,high,medium,low \
            --output json > scout-security-metrics.json

      - name: Upload metrics artifact
        uses: actions/upload-artifact@v4
        with:
          name: scout-security-metrics
          path: scout-security-metrics.json
